<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“š é˜…è¯»è®¡åˆ’</title>
<style>
  :root {
    --bg: #f5f0eb;
    --card: #ffffff;
    --primary: #5b4636;
    --accent: #c27c3e;
    --accent-light: #f0d9b5;
    --text: #3a3a3a;
    --text-light: #888;
    --border: #e0d6cc;
    --danger: #c0392b;
    --success: #27ae60;
    --shadow: 0 2px 12px rgba(91,70,54,0.08);
    --radius: 12px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  /* ===== é¡¶æ  ===== */
  .header {
    background: linear-gradient(135deg, var(--primary), #7a5f4f);
    color: #fff;
    padding: 20px 0;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 20px rgba(0,0,0,0.15);
  }
  .header-inner {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
  }
  .header h1 { font-size: 1.6em; font-weight: 700; letter-spacing: 1px; }
  .header h1 span { font-size: 0.55em; font-weight: 400; opacity: 0.8; margin-left: 12px; }
  .user-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(255,255,255,0.12);
    padding: 6px 16px;
    border-radius: 20px;
  }
  .user-bar label { font-size: 0.85em; opacity: 0.85; }
  .user-bar input {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    color: #fff;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.9em;
    width: 100px;
  }
  .user-bar input::placeholder { color: rgba(255,255,255,0.5); }

  /* ===== å·¥å…·æ  ===== */
  .toolbar {
    max-width: 1200px;
    margin: 20px auto 0;
    padding: 0 24px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
  }
  .toolbar .filter-group {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }
  .filter-btn {
    padding: 6px 16px;
    border: 1.5px solid var(--border);
    border-radius: 20px;
    background: var(--card);
    cursor: pointer;
    font-size: 0.85em;
    transition: all 0.2s;
    color: var(--text);
  }
  .filter-btn:hover { border-color: var(--accent); color: var(--accent); }
  .filter-btn.active {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
  }
  .toolbar .search-box {
    flex: 1;
    min-width: 200px;
    padding: 8px 16px;
    border: 1.5px solid var(--border);
    border-radius: 20px;
    font-size: 0.9em;
    background: var(--card);
    outline: none;
    transition: border-color 0.2s;
  }
  .toolbar .search-box:focus { border-color: var(--accent); }
  .add-btn {
    padding: 8px 24px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 20px;
    font-size: 0.95em;
    cursor: pointer;
    font-weight: 600;
    transition: transform 0.15s, box-shadow 0.15s;
  }
  .add-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(194,124,62,0.35); }

  /* ===== æ’åºæ  ===== */
  .sort-bar {
    max-width: 1200px;
    margin: 12px auto 0;
    padding: 0 24px;
    font-size: 0.82em;
    color: var(--text-light);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .sort-bar span { cursor: pointer; }
  .sort-bar span:hover { color: var(--accent); }
  .sort-bar span.active { color: var(--accent); font-weight: 600; }
  .book-count { margin-left: auto; }

  /* ===== ä¹¦ç±ç½‘æ ¼ ===== */
  .books-grid {
    max-width: 1200px;
    margin: 16px auto;
    padding: 0 24px 40px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 20px;
  }

  .book-card {
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    flex-direction: column;
  }
  .book-card:hover { transform: translateY(-3px); box-shadow: 0 6px 24px rgba(91,70,54,0.13); }

  .book-top {
    display: flex;
    padding: 20px;
    gap: 16px;
  }
  .book-cover {
    width: 90px;
    height: 128px;
    border-radius: 6px;
    object-fit: cover;
    background: var(--accent-light);
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5em;
    color: var(--primary);
  }
  .book-cover img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; }

  .book-info { flex: 1; min-width: 0; }
  .book-info h3 {
    font-size: 1.1em;
    margin-bottom: 4px;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .book-status {
    font-size: 0.65em;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 500;
    white-space: nowrap;
  }
  .status-candidate { background: #fef3cd; color: #856404; }
  .status-reading { background: #d1ecf1; color: #0c5460; }
  .status-finished { background: #d4edda; color: #155724; }

  .book-author { font-size: 0.88em; color: var(--text-light); margin-bottom: 6px; }
  .book-meta {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-bottom: 8px;
    flex-wrap: wrap;
  }
  .book-rating {
    background: var(--accent);
    color: #fff;
    padding: 1px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: 600;
  }
  .book-category {
    font-size: 0.78em;
    padding: 2px 8px;
    border-radius: 4px;
    background: var(--accent-light);
    color: var(--primary);
  }
  .book-synopsis {
    font-size: 0.83em;
    color: #666;
    line-height: 1.5;
    display: -webkit-box;
    line-clamp: 3;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .book-synopsis.expanded {
    display: block;
    line-clamp: unset;
    -webkit-line-clamp: initial;
    -webkit-box-orient: initial;
    overflow: visible;
  }
  .synopsis-toggle {
    margin-top: 6px;
    padding: 0;
    border: none;
    background: transparent;
    color: var(--accent);
    cursor: pointer;
    font-size: 0.78em;
    font-weight: 600;
  }
  .synopsis-toggle:hover {
    text-decoration: underline;
  }

  .book-actions {
    padding: 0 20px 16px;
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }
  .btn-sm {
    padding: 4px 12px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--card);
    cursor: pointer;
    font-size: 0.8em;
    transition: all 0.15s;
    color: var(--text);
  }
  .btn-sm:hover { border-color: var(--accent); color: var(--accent); }
  .btn-vote { }
  .btn-vote.voted { background: var(--accent); color: #fff; border-color: var(--accent); }
  .btn-del { color: var(--danger); border-color: #f5c6cb; }
  .btn-del:hover { background: var(--danger); color: #fff; }
  .btn-review { }
  .vote-count { font-size: 0.78em; color: var(--text-light); }
  .book-added-by { margin-left: auto; font-size: 0.72em; color: var(--text-light); }

  /* ===== ä¹¦è¯„åŒºåŸŸ ===== */
  .reviews-section {
    border-top: 1px solid var(--border);
    padding: 16px 20px;
    background: #faf8f5;
  }
  .reviews-section h4 {
    font-size: 0.9em;
    color: var(--primary);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
  }
  .reviews-section h4 .toggle-arrow {
    transition: transform 0.2s;
    font-size: 0.8em;
  }
  .reviews-section h4 .toggle-arrow.open { transform: rotate(90deg); }

  .review-item {
    background: var(--card);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    border: 1px solid var(--border);
  }
  .review-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
  }
  .review-user {
    font-weight: 600;
    color: var(--accent);
    font-size: 0.88em;
  }
  .review-rating { font-size: 0.82em; }
  .review-date { font-size: 0.75em; color: var(--text-light); margin-left: auto; }
  .review-content { font-size: 0.88em; line-height: 1.6; color: #555; }
  .review-actions { margin-top: 6px; display: flex; gap: 8px; }

  /* è¯„è®º */
  .comments-area { margin-top: 8px; padding-left: 16px; border-left: 2px solid var(--accent-light); }
  .comment-item {
    padding: 6px 0;
    font-size: 0.83em;
    border-bottom: 1px dashed var(--border);
  }
  .comment-item:last-child { border-bottom: none; }
  .comment-user { font-weight: 600; color: var(--accent); }
  .comment-date { font-size: 0.75em; color: var(--text-light); margin-left: 8px; }
  .comment-content { margin-top: 2px; color: #666; }
  .comment-input-row {
    display: flex;
    gap: 6px;
    margin-top: 8px;
  }
  .comment-input-row input {
    flex: 1;
    padding: 4px 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.85em;
    outline: none;
  }
  .comment-input-row input:focus { border-color: var(--accent); }
  .comment-input-row button {
    padding: 4px 12px;
    background: var(--primary);
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8em;
  }

  .review-form {
    margin-top: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .review-form textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 0.88em;
    resize: vertical;
    min-height: 80px;
    outline: none;
    font-family: inherit;
  }
  .review-form textarea:focus { border-color: var(--accent); }
  .review-form-row {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  .review-form-row label { font-size: 0.85em; }
  .review-form-row select {
    padding: 4px 8px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.85em;
  }
  .review-form-row button {
    margin-left: auto;
    padding: 6px 20px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
  }

  /* ===== æ¨¡æ€æ¡† ===== */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 200;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s;
  }
  .modal-overlay.show { opacity: 1; pointer-events: all; }
  .modal {
    background: var(--card);
    border-radius: 16px;
    padding: 32px;
    width: 90%;
    max-width: 520px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 12px 48px rgba(0,0,0,0.2);
    transform: translateY(24px);
    transition: transform 0.25s;
  }
  .modal-overlay.show .modal { transform: translateY(0); }
  .modal h2 {
    font-size: 1.25em;
    color: var(--primary);
    margin-bottom: 20px;
    text-align: center;
  }
  .modal .form-group {
    margin-bottom: 14px;
  }
  .modal .form-group label {
    display: block;
    font-size: 0.88em;
    font-weight: 600;
    margin-bottom: 4px;
    color: var(--primary);
  }
  .modal .form-group input,
  .modal .form-group textarea,
  .modal .form-group select {
    width: 100%;
    padding: 8px 12px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-size: 0.9em;
    outline: none;
    font-family: inherit;
    transition: border-color 0.2s;
  }
  .modal .form-group input:focus,
  .modal .form-group textarea:focus,
  .modal .form-group select:focus { border-color: var(--accent); }
  .modal .form-group textarea { min-height: 80px; resize: vertical; }
  .modal .form-row { display: flex; gap: 12px; }
  .modal .form-row .form-group { flex: 1; }

  .modal-actions {
    display: flex;
    gap: 12px;
    margin-top: 20px;
    justify-content: flex-end;
  }
  .modal-actions button {
    padding: 8px 24px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 0.92em;
    font-weight: 600;
    transition: all 0.15s;
  }
  .btn-cancel { background: var(--border); color: var(--text); }
  .btn-cancel:hover { background: #d0c4b8; }
  .btn-confirm { background: var(--accent); color: #fff; }
  .btn-confirm:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(194,124,62,0.3); }

  /* ===== åˆ é™¤ç¡®è®¤ ===== */
  .confirm-text { text-align: center; font-size: 0.95em; margin-bottom: 10px; color: #555; }

  /* ===== ç©ºçŠ¶æ€ ===== */
  .empty-state {
    text-align: center;
    padding: 80px 20px;
    color: var(--text-light);
  }
  .empty-state .icon { font-size: 4em; margin-bottom: 16px; }
  .empty-state p { font-size: 1.05em; }
  .empty-state .hint { font-size: 0.85em; margin-top: 8px; }

  /* ===== çŠ¶æ€é€‰æ‹©å™¨ ===== */
  .status-select {
    padding: 2px 6px;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 0.78em;
    background: var(--card);
    cursor: pointer;
  }

  /* ===== å“åº”å¼ ===== */
  @media (max-width: 600px) {
    .books-grid { grid-template-columns: 1fr; }
    .header-inner { flex-direction: column; align-items: flex-start; }
    .toolbar { flex-direction: column; }
    .book-top { flex-direction: column; align-items: center; text-align: center; }
    .book-cover { width: 120px; height: 170px; }
  }

  /* star rating */
  .star-rating { display: inline-flex; gap: 2px; cursor: pointer; }
  .star-rating .star { font-size: 1.2em; color: #ddd; transition: color 0.15s; }
  .star-rating .star.filled { color: #f5a623; }
  .star-rating .star:hover { color: #f5a623; }

  /* åˆ é™¤è¯„è®ºæŒ‰é’® */
  .btn-del-comment {
    background: none;
    border: none;
    color: var(--text-light);
    cursor: pointer;
    font-size: 0.75em;
    padding: 0 4px;
  }
  .btn-del-comment:hover { color: var(--danger); }

  .btn-del-review {
    background: none;
    border: 1px solid #f5c6cb;
    color: var(--danger);
    cursor: pointer;
    font-size: 0.75em;
    padding: 2px 8px;
    border-radius: 4px;
  }
  .btn-del-review:hover { background: var(--danger); color: #fff; }

  .search-auto-wrap { position: relative; }
  .auto-list {
    position: absolute;
    left: 0;
    right: 0;
    top: calc(100% + 4px);
    z-index: 20;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: var(--shadow);
    max-height: 220px;
    overflow-y: auto;
    display: none;
  }
  .auto-item {
    padding: 8px 10px;
    border-bottom: 1px solid #f1e9e1;
    cursor: pointer;
  }
  .auto-item:last-child { border-bottom: none; }
  .auto-item:hover { background: var(--accent-light); }
  .auto-title { font-size: 0.88em; color: var(--primary); font-weight: 600; }
  .auto-meta { font-size: 0.78em; color: var(--text-light); margin-top: 2px; }

  .resource-links {
    margin-top: 8px;
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }
  .resource-link {
    font-size: 0.74em;
    color: var(--primary);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 2px 8px;
    text-decoration: none;
    background: #fff;
  }
  .resource-link:hover {
    border-color: var(--accent);
    color: var(--accent);
  }
</style>
</head>
<body>

<!-- é¡¶æ  -->
<div class="header">
  <div class="header-inner">
    <h1>ğŸ“š é˜…è¯»è®¡åˆ’<span>ä¸€èµ·è¯»å¥½ä¹¦</span></h1>
    <div class="user-bar">
      <label>ğŸ‘¤ æˆ‘çš„ ID:</label>
      <input type="text" id="userId" placeholder="è¾“å…¥ä½ çš„æ˜µç§°" />
      <span id="activeGroupTag" style="font-size:0.8em; opacity:0.85;">å½“å‰ï¼šä¸ªäººæ¨¡å¼</span>
    </div>
  </div>
</div>

<div class="toolbar" style="margin-top:10px;">
  <a class="filter-btn active" href="index.html">ğŸ  ä¹¦å•</a>
  <a class="filter-btn" id="myPageLink" href="profile.html">ğŸ‘¤ ä¸ªäººä¸»é¡µ</a>
  <a class="filter-btn" id="groupPageLink" href="group.html">ğŸ‘¥ ç¾¤ç»„é¡µ</a>
  <a class="filter-btn" id="reviewPageLink" href="reviews.html">ğŸ’¬ ä¹¦è¯„å¹¿åœº</a>
</div>

<!-- å·¥å…·æ  -->
<div class="toolbar">
  <div class="filter-group">
    <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
    <button class="filter-btn" data-filter="candidate">ğŸ“‹ å¤‡é€‰</button>
    <button class="filter-btn" data-filter="reading">ğŸ“– åœ¨è¯»</button>
    <button class="filter-btn" data-filter="finished">âœ… å·²è¯»</button>
  </div>
  <input type="text" class="search-box" id="searchBox" placeholder="ğŸ” æœç´¢ä¹¦åã€ä½œè€…ã€åˆ†ç±»..." />
  <button class="add-btn" onclick="openAddModal()">ï¼‹ æ·»åŠ ä¹¦ç±</button>
</div>

<!-- æ’åºæ  -->
<div class="sort-bar">
  æ’åºï¼š
  <span class="active" data-sort="addedAt" onclick="setSort('addedAt')">æœ€è¿‘æ·»åŠ </span> |
  <span data-sort="votes" onclick="setSort('votes')">æœ€å¤šæƒ³è¯»</span> |
  <span data-sort="rating" onclick="setSort('rating')">è¯„åˆ†æœ€é«˜</span> |
  <span data-sort="reviews" onclick="setSort('reviews')">æœ€å¤šä¹¦è¯„</span>
  <span class="book-count" id="bookCount"></span>
</div>

<!-- ä¹¦ç±åˆ—è¡¨ -->
<div class="books-grid" id="booksGrid"></div>

<!-- æ·»åŠ ä¹¦ç±æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="addModal">
  <div class="modal" style="max-width: 600px;">
    <h2>ğŸ“– æ·»åŠ æ–°ä¹¦</h2>
    
    <!-- æœç´¢éƒ¨åˆ† -->
    <div style="background: #f5f0eb; padding: 14px; border-radius: 8px; margin-bottom: 16px;">
      <div class="form-group">
        <label>ğŸ“š æœç´¢ä¹¦ç± (å¯é€‰)</label>
        <p style="font-size: 0.8em; color: #888; margin-bottom: 8px;">è¾“å…¥ä¹¦åå’Œä½œè€…æœç´¢ï¼Œè‡ªåŠ¨å¡«å……ä¿¡æ¯</p>
        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
          <input type="text" id="searchTitle" placeholder="è¾“å…¥ä¹¦å..." style="flex: 1;" />
          <input type="text" id="searchAuthor" placeholder="è¾“å…¥ä½œè€…..." style="flex: 1;" />
          <button onclick="searchBookInfo()" style="padding: 8px 16px; background: var(--primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">ğŸ” æœç´¢</button>
        </div>
      </div>
      <div id="searchResults" style="display: none; max-height: 200px; overflow-y: auto;">
        <!-- æœç´¢ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
      </div>
    </div>

    <!-- æ‰‹åŠ¨è¾“å…¥éƒ¨åˆ† -->
    <div>
      <p style="font-size: 0.8em; color: #999; margin-bottom: 10px; text-align: center;">æˆ–è€…æ‰‹åŠ¨è¾“å…¥ä¿¡æ¯</p>
      <div class="form-group">
        <label>ä¹¦å *</label>
        <input type="text" id="inputTitle" placeholder="è¯·è¾“å…¥ä¹¦å" />
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>ä½œè€…</label>
          <input type="text" id="inputAuthor" placeholder="ä¾‹ï¼šæ‘ä¸Šæ˜¥æ ‘" />
        </div>
        <div class="form-group">
          <label>åˆ†ç±»</label>
          <select id="inputCategory">
            <option value="æ–‡å­¦å°è¯´">æ–‡å­¦å°è¯´</option>
            <option value="ç§‘å¹»å¥‡å¹»">ç§‘å¹»å¥‡å¹»</option>
            <option value="æ¨ç†æ‚¬ç–‘">æ¨ç†æ‚¬ç–‘</option>
            <option value="å†å²ä¼ è®°">å†å²ä¼ è®°</option>
            <option value="å“²å­¦æ€æƒ³">å“²å­¦æ€æƒ³</option>
            <option value="ç¤¾ä¼šç§‘å­¦">ç¤¾ä¼šç§‘å­¦</option>
            <option value="è‡ªç„¶ç§‘å­¦">è‡ªç„¶ç§‘å­¦</option>
            <option value="å¿ƒç†å­¦">å¿ƒç†å­¦</option>
            <option value="ç»æµç®¡ç†">ç»æµç®¡ç†</option>
            <option value="ç§‘æŠ€">ç§‘æŠ€</option>
            <option value="è‰ºæœ¯è®¾è®¡">è‰ºæœ¯è®¾è®¡</option>
            <option value="ç”Ÿæ´»">ç”Ÿæ´»</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>è¯„åˆ†</label>
          <input type="number" id="inputRating" placeholder="ä¾‹ï¼š8.5" min="0" max="10" step="0.1" />
        </div>
        <div class="form-group">
          <label>è¯„åˆ†æ¥æº</label>
          <input type="text" id="inputRatingSource" placeholder="ä¾‹ï¼šè±†ç“£" />
        </div>
      </div>
      <div class="form-group">
        <label>å°é¢å›¾ç‰‡ URL</label>
        <input type="text" id="inputCover" placeholder="å¯é€‰ï¼Œç²˜è´´å›¾ç‰‡é“¾æ¥" />
      </div>
      <div class="form-group">
        <label>ç®€ä»‹</label>
        <textarea id="inputSynopsis" placeholder="ç®€è¦ä»‹ç»è¿™æœ¬ä¹¦çš„å†…å®¹..."></textarea>
      </div>

      <div style="margin-top:12px; border-top:1px dashed var(--border); padding-top:12px;">
        <label style="display:block; font-size:0.88em; font-weight:600; margin-bottom:6px; color:var(--primary);">ğŸ“¦ æ‰¹é‡ä¸Šä¼ ï¼ˆæŒ‰è¡Œè¾“å…¥ï¼‰</label>
        <p style="font-size:0.8em; color:#888; margin-bottom:8px;">æ¯è¡Œä¸€æœ¬ï¼Œæ”¯æŒã€Œä¹¦åã€æˆ–ã€Œä¹¦å | ä½œè€…ã€ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æœç´¢å¹¶è¡¥å…¨åæ‰¹é‡æ·»åŠ ã€‚</p>
        <textarea id="bulkTitles" placeholder="ç¤ºä¾‹ï¼š
ç™¾å¹´å­¤ç‹¬
ä¸‰ä½“ | åˆ˜æ…ˆæ¬£
å±€å¤–äºº | é˜¿å°”è´Â·åŠ ç¼ª" style="width:100%; min-height:110px; padding:10px; border:1px solid var(--border); border-radius:8px; resize:vertical; font-family:inherit;"></textarea>
        <div style="display:flex; justify-content:flex-end; margin-top:8px;">
          <button class="btn-confirm" id="bulkSubmitBtn" type="button" onclick="submitBulkBooks()">æ‰¹é‡æ·»åŠ </button>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeAddModal()">å–æ¶ˆ</button>
      <button class="btn-confirm" onclick="submitBook()">æ·»åŠ </button>
    </div>
  </div>
</div>

<!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal" style="max-width: 380px;">
    <h2>âš ï¸ ç¡®è®¤åˆ é™¤</h2>
    <p class="confirm-text" id="deleteText"></p>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeDeleteModal()">å–æ¶ˆ</button>
      <button class="btn-confirm" style="background:var(--danger)" onclick="confirmDelete()">åˆ é™¤</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="sessionModal" style="z-index:300;">
  <div class="modal" style="max-width:420px;">
    <h2>æ¬¢è¿è¿›å…¥é˜…è¯»è®¡åˆ’</h2>
    <div class="form-group">
      <label>ä½ çš„ IDï¼ˆå¿…å¡«ï¼‰</label>
      <input type="text" id="sessionUserId" placeholder="ä¾‹å¦‚ï¼šalice" />
    </div>
    <p style="font-size:0.85em; color:#777; margin:0;">ç¾¤ç»„å¯ç¨ååœ¨ã€Œç¾¤ç»„é¡µã€åŠ å…¥å’Œåˆ‡æ¢ï¼Œä½ å¯ä»¥å…ˆä¸ªäººä½¿ç”¨ã€‚</p>
    <div class="modal-actions">
      <button class="btn-confirm" onclick="confirmSession()">è¿›å…¥</button>
    </div>
  </div>
</div>

<script>
// ========== å…¨å±€çŠ¶æ€ ==========
let books = [];
let currentFilter = 'all';
let currentSort = 'addedAt';
let searchQuery = '';
let deleteTarget = null;
let expandedReviews = {};
let expandedSynopsis = {};
let selectedSearchResources = [];
let sessionReady = false;

// ç”¨æˆ· ID
const userIdInput = document.getElementById('userId');
userIdInput.value = localStorage.getItem('readingclub_userId') || '';
userIdInput.addEventListener('input', () => {
  localStorage.setItem('readingclub_userId', userIdInput.value);
  updateNavLinks();
});

function getUserId() {
  return userIdInput.value.trim();
}

function getActiveGroupId() {
  const gid = (localStorage.getItem('readingclub_activeGroupId') || '').trim();
  if (gid) return gid;
  const uid = getUserId();
  return uid ? `solo:${uid}` : '';
}

function updateNavLinks() {
  const activeGroup = getActiveGroupId();
  const params = new URLSearchParams({ userId: getUserId(), groupId: activeGroup }).toString();
  document.getElementById('myPageLink').href = `profile.html?${params}`;
  document.getElementById('groupPageLink').href = `group.html?${params}`;
  document.getElementById('reviewPageLink').href = `reviews.html?${params}`;
  const tag = document.getElementById('activeGroupTag');
  if (tag) {
    tag.textContent = activeGroup && !activeGroup.startsWith('solo:') ? `å½“å‰ç¾¤ç»„ï¼š${activeGroup}` : 'å½“å‰ï¼šä¸ªäººæ¨¡å¼';
  }
}

async function requireSession() {
  const uid = getUserId();
  if (uid) {
    sessionReady = true;
    updateNavLinks();
    return true;
  }
  document.getElementById('sessionUserId').value = uid;
  document.getElementById('sessionModal').classList.add('show');
  return false;
}

async function confirmSession() {
  const uid = document.getElementById('sessionUserId').value.trim();
  if (!uid) {
    alert('ID ä¸èƒ½ä¸ºç©º');
    return;
  }
  userIdInput.value = uid;
  localStorage.setItem('readingclub_userId', uid);
  document.getElementById('sessionModal').classList.remove('show');
  sessionReady = true;
  updateNavLinks();
  await loadBooks();
}

// ========== API è°ƒç”¨ ==========
async function api(url, method = 'GET', body = null) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(url, opts);
  const raw = await res.text();
  let data = {};
  try {
    data = raw ? JSON.parse(raw) : {};
  } catch (e) {
    data = { error: raw || `è¯·æ±‚å¤±è´¥ï¼ˆ${res.status}ï¼‰` };
  }
  data._ok = res.ok;
  data._status = res.status;
  if (!res.ok && !data.error) {
    data.error = `è¯·æ±‚å¤±è´¥ï¼ˆ${res.status}ï¼‰`;
  }
  return data;
}

async function loadBooks() {
  if (!sessionReady) {
    const ok = await requireSession();
    if (!ok) return;
  }
  const params = new URLSearchParams({ userId: getUserId(), groupId: getActiveGroupId() });
  books = await api(`/api/books?${params}`);
  render();
}

// ========== æ¸²æŸ“ ==========
function render() {
  let filtered = books.filter(b => {
    if (currentFilter !== 'all' && b.status !== currentFilter) return false;
    if (searchQuery) {
      const q = searchQuery.toLowerCase();
      return b.title.toLowerCase().includes(q) ||
             b.author.toLowerCase().includes(q) ||
             b.category.toLowerCase().includes(q);
    }
    return true;
  });

  // æ’åº
  filtered.sort((a, b) => {
    switch (currentSort) {
      case 'votes': return Object.keys(b.votes || {}).length - Object.keys(a.votes || {}).length;
      case 'rating': return (b.rating || 0) - (a.rating || 0);
      case 'reviews': return (b.reviews || []).length - (a.reviews || []).length;
      default: return new Date(b.addedAt) - new Date(a.addedAt);
    }
  });

  document.getElementById('bookCount').textContent = `å…± ${filtered.length} æœ¬`;

  const grid = document.getElementById('booksGrid');
  if (filtered.length === 0) {
    grid.innerHTML = `
      <div class="empty-state" style="grid-column:1/-1;">
        <div class="icon">ğŸ“š</div>
        <p>è¿˜æ²¡æœ‰ä¹¦ç±</p>
        <p class="hint">ç‚¹å‡»ã€Œï¼‹ æ·»åŠ ä¹¦ç±ã€å¼€å§‹ä½ ä»¬çš„é˜…è¯»è®¡åˆ’å§ï¼</p>
      </div>`;
    return;
  }

  grid.innerHTML = filtered.map(book => renderBookCard(book)).join('');
  syncSynopsisToggles();
}

function renderBookCard(book) {
  const voteCount = Object.keys(book.votes || {}).length;
  const voted = book.votes && book.votes[getUserId()];
  const voters = Object.keys(book.votes || {}).join(', ') || 'æš‚æ— ';
  const statusLabels = { candidate: 'å¤‡é€‰', reading: 'åœ¨è¯»', finished: 'å·²è¯»' };
  const reviewCount = (book.reviews || []).length;
  const isSynopsisExpanded = !!expandedSynopsis[book.id];

  const coverHtml = book.cover
    ? `<div class="book-cover"><img src="${escHtml(book.cover)}" alt="å°é¢" onerror="this.parentElement.innerHTML='ğŸ“–'" /></div>`
    : `<div class="book-cover">ğŸ“–</div>`;

  const resourcePriority = { 'ç”µå­ä¹¦': 1, 'åœ¨çº¿é˜…è¯»': 2, 'å€Ÿé˜…': 3, 'é¢„è§ˆ': 4, 'è¯¦æƒ…': 5, 'æ£€ç´¢': 6 };
  const resources = (book.resources || [])
    .slice()
    .sort((a, b) => (resourcePriority[a.type] || 99) - (resourcePriority[b.type] || 99))
    .slice(0, 8);
  const resourcesHtml = resources.length
    ? `<details style="margin-top:8px;"><summary style="cursor:pointer; font-size:0.8em; color:var(--primary)">èµ„æºé“¾æ¥ (${resources.length})</summary>
        <div style="margin-top:6px; display:flex; flex-direction:column; gap:6px;">
          ${resources.map(r => `<a href="${escHtml(r.url || '#')}" target="_blank" rel="noopener noreferrer" style="font-size:0.78em; color:var(--primary); text-decoration:none; background:var(--accent-light); border-radius:12px; padding:3px 10px; width:max-content;">${escHtml(r.type ? r.type + 'ï¼š' : '')}${escHtml(r.name || 'èµ„æº')}</a>`).join('')}
        </div>
      </details>`
    : '';
  const voteListHtml = `<details style="margin-left:6px;"><summary style="cursor:pointer; font-size:0.75em; color:#666;">æƒ³è¯»åå•</summary><div style="font-size:0.75em; color:#666; max-width:180px;">${escHtml(voters)}</div></details>`;

  return `
    <div class="book-card">
      <div class="book-top">
        ${coverHtml}
        <div class="book-info">
          <h3>
            ${escHtml(book.title)}
            <span class="book-status status-${book.status}">${statusLabels[book.status]}</span>
          </h3>
          <div class="book-author">âœï¸ ${escHtml(book.author || 'æœªçŸ¥ä½œè€…')}</div>
          <div class="book-meta">
            ${book.rating ? `<span class="book-rating">â­ ${book.rating}${book.ratingSource ? ' Â· ' + escHtml(book.ratingSource) : ''}</span>` : ''}
            <span class="book-category">${escHtml(book.category)}</span>
          </div>
          <div class="book-synopsis ${isSynopsisExpanded ? 'expanded' : ''}" id="synopsis-${book.id}">${escHtml(book.synopsis || 'æš‚æ— ç®€ä»‹')}</div>
          <button type="button" class="synopsis-toggle" id="synopsisToggle-${book.id}" onclick="toggleSynopsis('${book.id}')">${isSynopsisExpanded ? 'æ”¶èµ·' : 'å±•å¼€'}</button>
          ${resourcesHtml}
        </div>
      </div>
      <div class="book-actions">
        <button class="btn-sm btn-vote ${voted ? 'voted' : ''}" onclick="toggleVote('${book.id}')" title="æƒ³è¯»çš„äººï¼š${escHtml(voters)}">
          ${voted ? 'â¤ï¸' : 'ğŸ¤'} æƒ³è¯» (${voteCount})
        </button>
        ${voteListHtml}
        <select class="status-select" onchange="changeStatus('${book.id}', this.value)">
          <option value="candidate" ${book.status === 'candidate' ? 'selected' : ''}>ğŸ“‹ å¤‡é€‰</option>
          <option value="reading" ${book.status === 'reading' ? 'selected' : ''}>ğŸ“– åœ¨è¯»</option>
          <option value="finished" ${book.status === 'finished' ? 'selected' : ''}>âœ… å·²è¯»</option>
        </select>
        <a class="btn-sm btn-review" style="text-decoration:none;" href="reviews.html?bookId=${book.id}&userId=${encodeURIComponent(getUserId())}&groupId=${encodeURIComponent(getActiveGroupId())}">ğŸ’¬ ä¹¦è¯„ (${reviewCount})</a>
        <button class="btn-sm btn-del" onclick="openDeleteModal('${book.id}', '${escHtml(book.title)}')">ğŸ—‘ï¸</button>
        <span class="book-added-by">ç”± ${escHtml(book.addedBy)} æ·»åŠ </span>
      </div>
    </div>`;
}

function renderReviews(book) {
  const reviews = book.reviews || [];
  let html = `<h4 onclick="toggleReviews('${book.id}')">
    <span class="toggle-arrow open">â–¶</span> ä¹¦è¯„ä¸è®¨è®º (${reviews.length})
  </h4>`;

  reviews.forEach(r => {
    const stars = r.rating ? 'â­'.repeat(r.rating) : '';
    const comments = r.comments || [];
    html += `
      <div class="review-item">
        <div class="review-header">
          <span class="review-user">@${escHtml(r.userId)}</span>
          <span class="review-rating">${stars}</span>
          <span class="review-date">${formatDate(r.createdAt)}</span>
        </div>
        <div class="review-content">${escHtml(r.content)}</div>
        <div class="review-actions">
          <button class="btn-del-review" onclick="deleteReview('${book.id}','${r.id}')">åˆ é™¤ä¹¦è¯„</button>
        </div>
        <div class="comments-area">
          ${comments.map(c => `
            <div class="comment-item">
              <span class="comment-user">@${escHtml(c.userId)}</span>
              <span class="comment-date">${formatDate(c.createdAt)}</span>
              <button class="btn-del-comment" onclick="deleteComment('${book.id}','${r.id}','${c.id}')">âœ•</button>
              <div class="comment-content">${escHtml(c.content)}</div>
            </div>`).join('')}
          <div class="comment-input-row">
            <input type="text" placeholder="å›å¤è®¨è®º..." id="comment-${r.id}" onkeydown="if(event.key==='Enter')addComment('${book.id}','${r.id}')" />
            <button onclick="addComment('${book.id}','${r.id}')">å‘é€</button>
          </div>
        </div>
      </div>`;
  });

  // å†™ä¹¦è¯„è¡¨å•
  html += `
    <div class="review-form">
      <textarea id="review-content-${book.id}" placeholder="å†™ä¸‹ä½ çš„ä¹¦è¯„..."></textarea>
      <div class="review-form-row">
        <label>è¯„åˆ†ï¼š</label>
        <select id="review-rating-${book.id}">
          <option value="">ä¸è¯„åˆ†</option>
          <option value="1">â­</option>
          <option value="2">â­â­</option>
          <option value="3">â­â­â­</option>
          <option value="4">â­â­â­â­</option>
          <option value="5">â­â­â­â­â­</option>
        </select>
        <button onclick="submitReview('${book.id}')">å‘å¸ƒä¹¦è¯„</button>
      </div>
    </div>`;

  return html;
}

// ========== äº¤äº’ ==========
function toggleReviews(bookId) {
  expandedReviews[bookId] = !expandedReviews[bookId];
  render();
}

function toggleSynopsis(bookId) {
  expandedSynopsis[bookId] = !expandedSynopsis[bookId];
  render();
}

function syncSynopsisToggles() {
  document.querySelectorAll('.book-synopsis').forEach(el => {
    const synopsisId = el.id || '';
    if (!synopsisId.startsWith('synopsis-')) return;
    const bookId = synopsisId.slice('synopsis-'.length);
    const toggle = document.getElementById(`synopsisToggle-${bookId}`);
    if (!toggle) return;

    const expanded = !!expandedSynopsis[bookId];
    const hasOverflow = el.scrollHeight > el.clientHeight + 1;
    const shouldShow = expanded || hasOverflow;

    toggle.style.display = shouldShow ? 'inline-block' : 'none';
    toggle.textContent = expanded ? 'æ”¶èµ·' : 'å±•å¼€';
  });
}

async function toggleVote(bookId) {
  await api(`/api/books/${bookId}/vote`, 'POST', { userId: getUserId(), groupId: getActiveGroupId() });
  await loadBooks();
}

async function changeStatus(bookId, status) {
  await api(`/api/books/${bookId}`, 'PUT', { status, userId: getUserId(), groupId: getActiveGroupId() });
  await loadBooks();
}

async function submitReview(bookId) {
  const content = document.getElementById(`review-content-${bookId}`).value.trim();
  if (!content) return alert('è¯·å¡«å†™ä¹¦è¯„å†…å®¹');
  const rating = document.getElementById(`review-rating-${bookId}`).value;
  await api(`/api/books/${bookId}/reviews`, 'POST', {
    userId: getUserId(),
    content,
    rating: rating ? parseInt(rating) : null
  });
  await loadBooks();
  expandedReviews[bookId] = true;
  render();
}

async function deleteReview(bookId, reviewId) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ä¹¦è¯„å—ï¼Ÿ')) return;
  await api(`/api/books/${bookId}/reviews/${reviewId}`, 'DELETE');
  await loadBooks();
  expandedReviews[bookId] = true;
  render();
}

async function addComment(bookId, reviewId) {
  const input = document.getElementById(`comment-${reviewId}`);
  const content = input.value.trim();
  if (!content) return;
  await api(`/api/books/${bookId}/reviews/${reviewId}/comments`, 'POST', {
    userId: getUserId(),
    content
  });
  await loadBooks();
  expandedReviews[bookId] = true;
  render();
}

async function deleteComment(bookId, reviewId, commentId) {
  await api(`/api/books/${bookId}/reviews/${reviewId}/comments/${commentId}`, 'DELETE');
  await loadBooks();
  expandedReviews[bookId] = true;
  render();
}

// ========== æ·»åŠ ä¹¦ç± ==========
async function openAddModal() {
  const ok = await requireSession();
  if (!ok) return;
  document.getElementById('addModal').classList.add('show');
  document.getElementById('inputTitle').focus();
}

function closeAddModal() {
  document.getElementById('addModal').classList.remove('show');
  ['searchTitle', 'searchAuthor', 'inputTitle','inputAuthor','inputRating','inputRatingSource','inputCover','inputSynopsis','bulkTitles'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  selectedSearchResources = [];
  document.getElementById('searchResults').style.display = 'none';
}

async function searchBookInfo() {
  const title = document.getElementById('searchTitle').value.trim();
  const author = document.getElementById('searchAuthor').value.trim();
  
  if (!title) {
    alert('è¯·è¾“å…¥ä¹¦å');
    return;
  }

  const searchBtn = document.querySelector('[onclick="searchBookInfo()"]');
  searchBtn.textContent = 'â³ æœç´¢ä¸­...';
  searchBtn.disabled = true;

  try {
    const query = new URLSearchParams({
      title,
      author
    });
    const results = await api(`/api/search-book?${query}`);
    
    if (results.error) {
      alert(results.error);
      return;
    }

    if (results.length === 0) {
      alert('æœªæ‰¾åˆ°åŒ¹é…çš„ä¹¦ç±ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥');
      return;
    }

    const resultsDiv = document.getElementById('searchResults');
    resultsDiv.innerHTML = results.map((book, idx) => `
      <div style="padding: 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: all 0.15s;" onclick="selectSearchResult(${idx}, ${JSON.stringify(book).replace(/"/g, '&quot;')})" onmouseover="this.style.background='var(--accent-light)'" onmouseout="this.style.background='transparent'">
        <div style="font-weight: 600; color: var(--accent);">${escHtml(book.title)}</div>
        <div style="font-size: 0.85em; color: #888;">${escHtml(book.author || 'æœªçŸ¥')}</div>
        ${book.rating ? `<div style="font-size: 0.8em; color: var(--accent);"><strong>â­ ${book.rating}</strong> (${book.ratingSource})</div>` : ''}
        ${book.year ? `<div style="font-size: 0.8em; color: #999;">å‡ºç‰ˆ: ${book.year}</div>` : ''}
        <div style="font-size: 0.78em; color: #666; margin-top: 3px;">æ¥æº: ${escHtml(book.source || 'èšåˆç»“æœ')} ${book.resources?.length ? `Â· èµ„æº ${book.resources.length}` : ''}</div>
      </div>
    `).join('');
    resultsDiv.style.display = 'block';
  } catch (e) {
    alert('æœç´¢å¤±è´¥: ' + e.message);
  } finally {
    searchBtn.textContent = 'ğŸ” æœç´¢';
    searchBtn.disabled = false;
  }
}

function selectSearchResult(idx, book) {
  document.getElementById('inputTitle').value = book.title || '';
  document.getElementById('inputAuthor').value = book.author || '';
  document.getElementById('inputCategory').value = book.category || 'æ–‡å­¦å°è¯´';
  document.getElementById('inputRating').value = book.rating || '';
  document.getElementById('inputRatingSource').value = book.ratingSource || '';
  document.getElementById('inputCover').value = book.cover || '';
  document.getElementById('inputSynopsis').value = book.synopsis || '';
  selectedSearchResources = Array.isArray(book.resources) ? book.resources : [];
  
  document.getElementById('searchResults').style.display = 'none';
  document.getElementById('searchTitle').value = '';
  document.getElementById('searchAuthor').value = '';
}

async function submitBook() {
  const title = document.getElementById('inputTitle').value.trim();
  if (!title) return alert('ä¹¦åä¸èƒ½ä¸ºç©º');
  await api('/api/books', 'POST', {
    title,
    author: document.getElementById('inputAuthor').value.trim(),
    category: document.getElementById('inputCategory').value,
    rating: parseFloat(document.getElementById('inputRating').value) || null,
    ratingSource: document.getElementById('inputRatingSource').value.trim(),
    cover: document.getElementById('inputCover').value.trim(),
    synopsis: document.getElementById('inputSynopsis').value.trim(),
    resources: selectedSearchResources,
    addedBy: getUserId(),
    groupId: getActiveGroupId()
  });
  closeAddModal();
  await loadBooks();
}

async function submitBulkBooks() {
  const submitBtn = document.getElementById('bulkSubmitBtn');
  const originText = submitBtn ? submitBtn.textContent : 'æ‰¹é‡æ·»åŠ ';
  const raw = document.getElementById('bulkTitles').value;
  const lines = raw
    .split(/\r?\n/)
    .map(line => line.trim())
    .filter(Boolean);

  if (!lines.length) {
    alert('è¯·å…ˆè¾“å…¥è‡³å°‘ä¸€è¡Œä¹¦å');
    return;
  }

  try {
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = 'æ‰¹é‡æ·»åŠ ä¸­...';
    }

    const result = await api('/api/books/bulk', 'POST', {
      entries: lines,
      addedBy: getUserId(),
      groupId: getActiveGroupId()
    });

    if (!result._ok || result.error) {
      alert(result.error || 'æ‰¹é‡æ·»åŠ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      return;
    }

    const skipped = Array.isArray(result.skipped) ? result.skipped.length : 0;
    alert(`æ‰¹é‡ä¸Šä¼ å®Œæˆï¼šæˆåŠŸ ${result.count || 0} æœ¬ï¼Œè·³è¿‡ ${skipped} æœ¬`);
    closeAddModal();
    await loadBooks();
  } catch (e) {
    alert(`æ‰¹é‡æ·»åŠ å¤±è´¥ï¼š${e.message || e}`);
  } finally {
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.textContent = originText;
    }
  }
}

// ========== åˆ é™¤ä¹¦ç± ==========
function openDeleteModal(bookId, title) {
  deleteTarget = bookId;
  document.getElementById('deleteText').textContent = `ç¡®å®šè¦åˆ é™¤ã€Š${title}ã€‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`;
  document.getElementById('deleteModal').classList.add('show');
}
function closeDeleteModal() {
  document.getElementById('deleteModal').classList.remove('show');
  deleteTarget = null;
}
async function confirmDelete() {
  if (deleteTarget) {
    await api(`/api/books/${deleteTarget}`, 'DELETE');
    closeDeleteModal();
    await loadBooks();
  }
}

// ========== ç­›é€‰æ’åºæœç´¢ ==========
document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn[data-filter]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.filter;
    render();
  });
});

function setSort(sort) {
  currentSort = sort;
  document.querySelectorAll('.sort-bar span[data-sort]').forEach(el => {
    el.classList.toggle('active', el.dataset.sort === sort);
  });
  render();
}

document.getElementById('searchBox').addEventListener('input', e => {
  searchQuery = e.target.value;
  render();
});

// ========== å·¥å…·å‡½æ•° ==========
function escHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function formatDate(iso) {
  if (!iso) return '';
  const d = new Date(iso);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
}

// æŒ‰ ESC å…³é—­æ¨¡æ€æ¡†
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeAddModal();
    closeDeleteModal();
  }
});

// ç‚¹å‡»é®ç½©å…³é—­
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => {
    if (e.target === el) {
      closeAddModal();
      closeDeleteModal();
    }
  });
});

// ========== åˆå§‹åŒ– ==========
requireSession().then(ok => {
  if (ok) loadBooks();
});

// è‡ªåŠ¨è½®è¯¢åˆ·æ–°ï¼ˆåä½œç”¨ï¼Œæ¯ 5 ç§’ï¼‰
setInterval(loadBooks, 5000);
</script>
</body>
</html>
