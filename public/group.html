<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>ç¾¤ç»„åŠŸèƒ½</title>
	<style>
		body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: #f5f0eb; color: #3a3a3a; margin: 0; }
		.wrap { max-width: 1080px; margin: 0 auto; padding: 20px; }
		.btn { padding: 6px 12px; border: 1px solid #d8c7b7; border-radius: 8px; background: #fff; text-decoration: none; color: #5b4636; cursor: pointer; }
		.row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
		.card { background: #fff; border: 1px solid #eadfd5; border-radius: 12px; padding: 14px; margin-top: 14px; }
		.grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 10px; }
		.meta { font-size: 12px; color: #777; }
		input { padding: 7px 10px; border: 1px solid #d8c7b7; border-radius: 8px; }
		.tag { display: inline-block; background: #efdfc9; padding: 3px 10px; border-radius: 12px; }
		.tag.active { background: #d9b98f; }
		.danger { color: #a94442; }
	</style>
</head>
<body>
	<div class="wrap">
		<div class="row">
			<a class="btn" id="backHome" href="index.html">â† è¿”å›ä¹¦å•</a>
			<a class="btn" id="toProfile" href="profile.html">ä¸ªäººä¸»é¡µ</a>
			<h2 id="title" style="margin:0 0 0 auto;">ğŸ‘¥ ç¾¤ç»„åŠŸèƒ½</h2>
		</div>

		<div class="card">
			<div class="row" style="margin-bottom:10px;">
				<input id="createGroupName" placeholder="ç¾¤ç»„åç§°ï¼ˆå¯é€‰ï¼‰" style="min-width:220px" />
				<button class="btn" id="createGroupBtn">+ åˆ›å»ºç¾¤ç»„ï¼ˆç³»ç»Ÿåˆ†é…IDï¼‰</button>
				<span class="meta">åˆ›å»ºåä¼šè‡ªåŠ¨åŠ å…¥å¹¶è®¾ä¸ºå½“å‰ç¾¤ç»„ï¼ˆID ä¸å˜ï¼‰</span>
			</div>
			<div class="row">
				<input id="newGroupId" placeholder="è¾“å…¥ç¾¤ç»„IDåŠ å…¥" style="min-width:260px" />
				<button class="btn" id="joinGroupBtn">åŠ å…¥ç¾¤ç»„</button>
				<span class="meta">ä½ å¯ä»¥åŠ å…¥å¤šä¸ªç¾¤ç»„ï¼Œé¦–é¡µåªå±•ç¤ºå½“å‰æ¿€æ´»ç¾¤ç»„</span>
			</div>
		</div>

		<div id="groupList"></div>
		<div id="content"></div>
	</div>

	<script>
		const params = new URLSearchParams(location.search);
		const userId = params.get('userId') || localStorage.getItem('readingclub_userId') || '';
		let activeGroupId = params.get('groupId') || localStorage.getItem('readingclub_activeGroupId') || '';

		if (userId) localStorage.setItem('readingclub_userId', userId);
		if (activeGroupId && !activeGroupId.startsWith('solo:')) {
			localStorage.setItem('readingclub_activeGroupId', activeGroupId);
		}

		const titleEl = document.getElementById('title');
		const backHomeEl = document.getElementById('backHome');
		const toProfileEl = document.getElementById('toProfile');
		const groupListEl = document.getElementById('groupList');
		const contentEl = document.getElementById('content');

		titleEl.textContent = `ğŸ‘¥ ç¾¤ç»„åŠŸèƒ½ï¼ˆ@${userId || 'æœªç™»å½•'}ï¼‰`;

		function esc(value) {
			const div = document.createElement('div');
			div.textContent = value || '';
			return div.innerHTML;
		}

		function updateNavLinks() {
			const gid = activeGroupId || '';
			backHomeEl.href = `index.html?userId=${encodeURIComponent(userId)}&groupId=${encodeURIComponent(gid)}`;
			toProfileEl.href = `profile.html?userId=${encodeURIComponent(userId)}&groupId=${encodeURIComponent(gid)}`;
		}

		async function api(url, method = 'GET', body = null) {
			const opts = { method, headers: { 'Content-Type': 'application/json' } };
			if (body) opts.body = JSON.stringify(body);
			const res = await fetch(url, opts);
			const data = await res.json();
			if (!res.ok) {
				throw new Error(data.error || 'è¯·æ±‚å¤±è´¥');
			}
			return data;
		}

		function setActiveGroup(groupId) {
			activeGroupId = groupId || '';
			if (activeGroupId) {
				localStorage.setItem('readingclub_activeGroupId', activeGroupId);
			} else {
				localStorage.removeItem('readingclub_activeGroupId');
			}
			updateNavLinks();
			load();
		}

		async function createGroup() {
			if (!userId) {
				alert('è¯·å…ˆå›é¦–é¡µè®¾ç½®ç”¨æˆ·ID');
				return;
			}
			const groupName = document.getElementById('createGroupName').value.trim();
			const result = await api('/api/groups/create', 'POST', { userId, groupName });
			document.getElementById('createGroupName').value = '';
			alert(`åˆ›å»ºæˆåŠŸï¼\nç¾¤ç»„åï¼š${result.groupName || result.groupId}\nç¾¤ç»„IDï¼š${result.groupId}`);
			setActiveGroup(result.groupId);
		}

		async function renameGroup(groupId, triggerBtn) {
			if (!userId) {
				alert('è¯·å…ˆå›é¦–é¡µè®¾ç½®ç”¨æˆ·ID');
				return;
			}
			const row = triggerBtn ? triggerBtn.closest('.row') : null;
			const input = row ? row.querySelector('input[data-rename-for]') : null;
			if (!input) return;
			const groupName = input.value.trim();
			if (!groupName) {
				alert('ç¾¤ç»„åç§°ä¸èƒ½ä¸ºç©º');
				return;
			}
			await api(`/api/groups/${encodeURIComponent(groupId)}`, 'PUT', { userId, groupName });
			await load();
		}

		async function joinGroup() {
			if (!userId) {
				alert('è¯·å…ˆå›é¦–é¡µè®¾ç½®ç”¨æˆ·ID');
				return;
			}
			const gid = document.getElementById('newGroupId').value.trim();
			if (!gid) {
				alert('è¯·è¾“å…¥ç¾¤ç»„ID');
				return;
			}
			await api('/api/session/join', 'POST', { userId, groupId: gid });
			document.getElementById('newGroupId').value = '';
			setActiveGroup(gid);
		}

		function renderGroupList(groups) {
			if (!groups.length) {
				groupListEl.innerHTML = '<div class="card"><h3 style="margin:0 0 8px 0;">æˆ‘åŠ å…¥çš„ç¾¤ç»„</h3><div class="meta danger">å½“å‰æ²¡æœ‰ç¾¤ç»„ã€‚ä½ å¯ä»¥å…ˆåˆ›å»ºä¸€ä¸ªï¼Œæˆ–è¾“å…¥ç¾¤ç»„IDåŠ å…¥ã€‚</div></div>';
				return;
			}

			const html = groups.map(group => `
				<div class="row" style="margin:6px 0;">
					<span class="tag ${group.groupId === activeGroupId ? 'active' : ''}">${esc(group.groupName || group.groupId)}</span>
					<span class="meta">ID: ${esc(group.groupId)}</span>
					<span class="meta">æˆå‘˜ ${group.memberCount}</span>
					<button class="btn set-active-btn" data-group-id="${esc(group.groupId)}">è®¾ä¸ºå½“å‰</button>
					<input data-rename-for="${esc(group.groupId)}" value="${esc(group.groupName || group.groupId)}" placeholder="ä¿®æ”¹ç¾¤ç»„åç§°" style="min-width:180px" />
					<button class="btn rename-btn" data-group-id="${esc(group.groupId)}">æ”¹å</button>
				</div>
			`).join('');

			groupListEl.innerHTML = `<div class="card"><h3 style="margin:0 0 8px 0;">æˆ‘åŠ å…¥çš„ç¾¤ç»„</h3>${html}</div>`;
			groupListEl.querySelectorAll('.set-active-btn').forEach(btn => {
				btn.addEventListener('click', () => setActiveGroup(btn.dataset.groupId || ''));
			});
			groupListEl.querySelectorAll('.rename-btn').forEach(btn => {
				btn.addEventListener('click', () => renameGroup(btn.dataset.groupId || '', btn));
			});
		}

		function renderOverview(groupId, overview) {
			const members = overview.members || [];
			const shelves = overview.perUserShelves || {};
			const everyone = overview.everyoneReading || [];
			const reviews = overview.reviews || [];
			const groupName = overview.groupName || groupId;

			contentEl.innerHTML = `
				<div class="card">
					<h3 style="margin:0 0 8px 0;">å½“å‰ç¾¤ç»„ï¼š${esc(groupName)}</h3>
					<div class="meta" style="margin-bottom:8px;">ç¾¤ç»„IDï¼š${esc(groupId)}</div>
					<div>
						${members.map(member => `<span class="tag" style="margin:0 6px 6px 0;">@${esc(member)}</span>`).join('') || '<span class="meta">æš‚æ— æˆå‘˜</span>'}
					</div>
				</div>
				<div class="card">
					<h3 style="margin:0 0 8px 0;">ğŸ“– å¤§å®¶éƒ½åœ¨è¯»ï¼ˆ2äººåŠä»¥ä¸Šï¼‰</h3>
					${everyone.map(book => `<div style="padding:8px 0;border-bottom:1px dashed #eee;"><strong>${esc(book.title)}</strong><div class="meta">${esc((book.users || []).join('ã€'))}</div></div>`).join('') || '<div class="meta">æš‚æ— </div>'}
				</div>
				<div class="grid">
					${members.map(member => `
						<div class="card">
							<h3 style="margin:0 0 8px 0;">@${esc(member)}</h3>
							${['candidate', 'reading', 'finished'].map(status => `
								<details style="margin-bottom:6px;">
									<summary style="cursor:pointer;">${status === 'candidate' ? 'ğŸ“‹ æƒ³è¯»' : status === 'reading' ? 'ğŸ“– åœ¨è¯»' : 'âœ… å·²è¯»'} (${(shelves[member]?.[status] || []).length})</summary>
									<div style="margin-top:6px;">${(shelves[member]?.[status] || []).map(book => `<div style="font-size:13px; padding:4px 0;">${esc(book.title)}</div>`).join('') || '<span class="meta">æš‚æ— </span>'}</div>
								</details>
							`).join('')}
						</div>
					`).join('')}
				</div>
				<div class="card">
					<h3 style="margin:0 0 8px 0;">ğŸ’¬ ç¾¤ç»„ä¹¦è¯„</h3>
					${reviews.map(review => `<div style="padding:8px 0;border-bottom:1px dashed #eee;"><div class="meta">@${esc(review.userId)} Â· ã€Š${esc(review.bookTitle)}ã€‹</div><div>${esc(review.content || '')}</div></div>`).join('') || '<div class="meta">æš‚æ— ä¹¦è¯„</div>'}
				</div>
			`;
		}

		async function load() {
			updateNavLinks();
			if (!userId) {
				groupListEl.innerHTML = '<div class="card">è¯·å…ˆå›é¦–é¡µè®¾ç½®ç”¨æˆ·IDã€‚</div>';
				contentEl.innerHTML = '';
				return;
			}

			let groups = [];
			try {
				groups = await api(`/api/users/${encodeURIComponent(userId)}/groups`);
			} catch (error) {
				groupListEl.innerHTML = `<div class="card danger">åŠ è½½ç¾¤ç»„å¤±è´¥ï¼š${esc(error.message)}</div>`;
				contentEl.innerHTML = '';
				return;
			}

			const groupIds = new Set(groups.map(group => group.groupId));
			if (activeGroupId && !groupIds.has(activeGroupId)) {
				activeGroupId = '';
				localStorage.removeItem('readingclub_activeGroupId');
			}
			if (!activeGroupId && groups.length) {
				activeGroupId = groups[0].groupId;
				localStorage.setItem('readingclub_activeGroupId', activeGroupId);
			}

			renderGroupList(groups);

			if (!activeGroupId) {
				contentEl.innerHTML = '<div class="card"><div class="meta">å½“å‰æœªæ¿€æ´»ç¾¤ç»„ï¼Œä½ å¯ä»¥ç»§ç»­ä½¿ç”¨ä¸ªäººæ¨¡å¼ï¼Œæˆ–å…ˆåˆ›å»º/åŠ å…¥ä¸€ä¸ªç¾¤ç»„ã€‚</div></div>';
				updateNavLinks();
				return;
			}

			try {
				const overview = await api(`/api/groups/${encodeURIComponent(activeGroupId)}/overview`);
				renderOverview(activeGroupId, overview);
			} catch (error) {
				contentEl.innerHTML = `<div class="card danger">åŠ è½½ç¾¤ç»„æ¦‚è§ˆå¤±è´¥ï¼š${esc(error.message)}</div>`;
			}
		}

		document.getElementById('createGroupBtn').addEventListener('click', createGroup);
		document.getElementById('joinGroupBtn').addEventListener('click', joinGroup);

		load();
	</script>
</body>
</html>